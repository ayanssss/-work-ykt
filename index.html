<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Work</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --bg:#0b0f17; --card:#121a27; --text:#e8eefc; --muted:#9fb0d0; --accent:#4b8bff; --danger:#ff4b4b; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--text); }
    .wrap { max-width: 720px; margin: 0 auto; padding: 14px; }
    .card { background: var(--card); border: 1px solid rgba(255,255,255,.06); border-radius: 14px; padding: 12px; margin: 10px 0; }
    input, textarea, button {
      width: 100%; box-sizing: border-box;
      border-radius: 12px; border: 1px solid rgba(255,255,255,.12);
      padding: 10px 12px; background: rgba(255,255,255,.04); color: var(--text);
      outline: none;
    }
    textarea { min-height: 90px; resize: vertical; }
    button { background: var(--accent); border: none; font-weight: 700; cursor: pointer; }
    button.secondary { background: rgba(255,255,255,.08); font-weight: 600; }
    button.danger { background: var(--danger); }
    #map { height: 260px; border-radius: 12px; overflow: hidden; }
    .list { display: grid; gap: 10px; }
    .item { border: 1px solid rgba(255,255,255,.08); border-radius: 12px; padding: 10px; }
    .badge { display:inline-block; padding: 2px 8px; border-radius: 999px; background: rgba(255,255,255,.08); font-size: 12px; }
    .actions { display:flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .actions button { width: auto; padding: 9px 12px; }
    .muted { color: var(--muted); font-size: 14px; }
    .hidden { display:none !important; }
    .topbar { display:flex; gap: 10px; align-items:center; justify-content: space-between; }
    .topbar button { width:auto; }
    .modeBox { display: grid; gap: 12px; }
    .modeBottom { margin-top: 90px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <div style="font-weight:800; font-size:18px;">Work</div>
      <div class="muted" id="subtitle">Выберите режим</div>
    </div>
    <button class="secondary" id="btnLogout">Выйти</button>
  </div>

  <div class="card" id="modeCard">
    <h3>Режим</h3>
    <div class="modeBox">
      <button id="btnClient">Заказчик</button>
      <button class="secondary modeBottom" id="btnMaster">Мастер</button>
    </div>
  </div>

  <div class="hidden" id="clientView">
    <div class="card">
      <h3>Создать заявку</h3>
      <textarea id="desc" placeholder="Описание"></textarea>
      <input id="addr" placeholder="Адрес текстом">
      <div class="muted">Поставьте точку на карте (клик по карте).</div>
      <div id="map"></div>
      <div class="actions">
        <button id="btnCreateOrder">Создать</button>
        <button class="secondary" id="btnRefreshMyOrders">Обновить</button>
        <button class="secondary" id="btnBack1">Назад</button>
      </div>
    </div>

    <div class="card">
      <h3>Мои заявки</h3>
      <div class="list" id="myOrders"></div>
    </div>

    <div class="card hidden" id="clientOrderDetailsCard">
      <h3>Детали заявки</h3>
      <div id="clientOrderDetails"></div>
      <div class="actions">
        <button class="secondary" id="btnCloseClientDetails">Закрыть</button>
      </div>
    </div>
  </div>

  <div class="hidden" id="masterView">
    <div class="card">
      <h3>Лента заявок</h3>
      <div class="actions">
        <button id="btnRefreshFeed">Обновить</button>
        <button class="secondary" id="btnBack2">Назад</button>
      </div>
      <div class="list" id="feed"></div>
    </div>

    <div class="card hidden" id="masterOrderDetailsCard">
      <h3>Детали заявки</h3>
      <div id="masterOrderDetails"></div>
      <div class="actions">
        <button class="secondary" id="btnCloseMasterDetails">Закрыть</button>
      </div>
    </div>
  </div>

  <div class="muted" style="margin: 14px 4px;">
    Открывайте приложение через Telegram бота.
  </div>
</div>

<script>
  const API_BASE = "https://work-ykt.onrender.com";

  const tg = window.Telegram?.WebApp;
  tg?.ready();

  function toast(msg) {
    if (tg?.showPopup) tg.showPopup({ title: "Сообщение", message: String(msg), buttons: [{type:"ok"}] });
    else alert(msg);
  }

  let jwtToken = localStorage.getItem("jwt") || null;

  async function ensureAuth() {
    if (jwtToken) return jwtToken;
    const initData = tg?.initData;
    if (!initData) throw new Error("Нет Telegram initData. Откройте WebApp через бота.");
    const res = await fetch(API_BASE + "/auth/telegram", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ initData })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.detail || "Auth failed");
    jwtToken = data.token;
    localStorage.setItem("jwt", jwtToken);
    return jwtToken;
  }

  async function api(path, { method="GET", body=null } = {}) {
    const t = await ensureAuth();
    const res = await fetch(API_BASE + path, {
      method,
      headers: { "Content-Type":"application/json", "Authorization":"Bearer " + t },
      body: body ? JSON.stringify(body) : null
    });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = text; }
    if (!res.ok) throw new Error((data && data.detail) ? data.detail : text);
    return data;
  }

  document.getElementById("btnLogout").onclick = () => {
    localStorage.removeItem("jwt");
    jwtToken = null;
    toast("Вышли (токен удалён). Зайдите снова через бота.");
  };

  // Map
  const map = L.map('map').setView([55.751244, 37.618423], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  let marker = null;
  let picked = { lat: 55.751244, lon: 37.618423 };
  map.on('click', (e) => {
    picked = { lat: e.latlng.lat, lon: e.latlng.lng };
    if (marker) marker.setLatLng(e.latlng);
    else marker = L.marker(e.latlng).addTo(map);
  });

  // Views
  const modeCard = document.getElementById("modeCard");
  const clientView = document.getElementById("clientView");
  const masterView = document.getElementById("masterView");

  function showMode() {
    modeCard.classList.remove("hidden");
    clientView.classList.add("hidden");
    masterView.classList.add("hidden");
    document.getElementById("subtitle").textContent = "Выберите режим";
  }
  function showClient() {
    modeCard.classList.add("hidden");
    clientView.classList.remove("hidden");
    masterView.classList.add("hidden");
    document.getElementById("subtitle").textContent = "Режим: Заказчик";
    setTimeout(() => map.invalidateSize(), 50);
  }
  function showMaster() {
    modeCard.classList.add("hidden");
    clientView.classList.add("hidden");
    masterView.classList.remove("hidden");
    document.getElementById("subtitle").textContent = "Режим: Мастер";
  }

  document.getElementById("btnClient").onclick = async () => {
    try { await ensureAuth(); showClient(); await refreshMyOrders(); }
    catch(e){ toast(e.message); }
  };
  document.getElementById("btnMaster").onclick = async () => {
    try { await ensureAuth(); showMaster(); await refreshFeed(); }
    catch(e){ toast(e.message); }
  };
  document.getElementById("btnBack1").onclick = showMode;
  document.getElementById("btnBack2").onclick = showMode;

  // Client
  document.getElementById("btnCreateOrder").onclick = async () => {
    try {
      const description = document.getElementById("desc").value.trim();
      const address_text = document.getElementById("addr").value.trim();
      if (!description) throw new Error("Введите описание");
      if (!address_text) throw new Error("Введите адрес");

      await api("/orders", { method:"POST", body: {
        description, address_text, lat: picked.lat, lon: picked.lon
      }});

      document.getElementById("desc").value = "";
      document.getElementById("addr").value = "";
      toast("Заявка создана");
      await refreshMyOrders();
    } catch (e) { toast(e.message); }
  };

  document.getElementById("btnRefreshMyOrders").onclick = () => refreshMyOrders();

  async function refreshMyOrders() {
    const list = document.getElementById("myOrders");
    list.innerHTML = "";
    const orders = await api("/orders/my");
    if (!orders.length) {
      list.innerHTML = `<div class="muted">Пока нет заявок</div>`;
      return;
    }
    for (const o of orders) {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div><b>#${o.id}</b> <span class="badge">${o.status}</span></div>
        <div class="muted">${escapeHtml(o.address_text)}</div>
        <div style="margin-top:6px;">${escapeHtml(o.description)}</div>
        <div class="actions">
          <button class="secondary" data-open="${o.id}">Открыть</button>
          <button class="danger" data-cancel="${o.id}">Отменить</button>
        </div>
      `;
      el.querySelector("[data-open]").onclick = () => openClientOrder(o.id);
      el.querySelector("[data-cancel]").onclick = () => cancelOrder(o.id);
      list.appendChild(el);
    }
  }

  async function cancelOrder(orderId) {
    if (!confirm("Отменить заявку?")) return;
    try {
      await api(`/orders/${orderId}/cancel`, { method:"POST" });
      toast("Отменено");
      await refreshMyOrders();
    } catch (e) { toast(e.message); }
  }

  const clientDetailsCard = document.getElementById("clientOrderDetailsCard");
  document.getElementById("btnCloseClientDetails").onclick = () => clientDetailsCard.classList.add("hidden");

  async function openClientOrder(orderId) {
    const details = await api(`/orders/${orderId}`);
    const o = details.order;
    const responses = details.responses || [];

    let html = `
      <div><b>#${o.id}</b> <span class="badge">${o.status}</span></div>
      <div class="muted">${escapeHtml(o.address_text)}</div>
      <div style="margin-top:8px;">${escapeHtml(o.description)}</div>
      <div style="margin-top:10px;"><b>Отклики</b></div>
    `;

    if (!responses.length) {
      html += `<div class="muted">Пока нет откликов</div>`;
    } else {
      for (const r of responses) {
        html += `
          <div class="item" style="margin-top:8px;">
            <div><b>Мастер id ${r.master_id}</b> <span class="badge">${r.status}</span></div>
            <div class="actions">
              ${o.status === "open" && r.status === "pending" ? `
                <button data-acc="${r.id}">Принять</button>
                <button class="secondary" data-rej="${r.id}">Отклонить</button>
              ` : ``}
            </div>
          </div>
        `;
      }
    }

    clientDetailsCard.classList.remove("hidden");
    const box = document.getElementById("clientOrderDetails");
    box.innerHTML = html;

    box.querySelectorAll("[data-acc]").forEach(btn => {
      btn.onclick = async () => {
        await api(`/orders/${orderId}/accept`, { method:"POST", body:{ response_id: Number(btn.dataset.acc) }});
        toast("Мастер принят");
        await openClientOrder(orderId);
        await refreshMyOrders();
      };
    });
    box.querySelectorAll("[data-rej]").forEach(btn => {
      btn.onclick = async () => {
        await api(`/orders/${orderId}/reject`, { method:"POST", body:{ response_id: Number(btn.dataset.rej) }});
        toast("Отклик отклонён");
        await openClientOrder(orderId);
      };
    });
  }

  // Master
  document.getElementById("btnRefreshFeed").onclick = () => refreshFeed();
  const masterDetailsCard = document.getElementById("masterOrderDetailsCard");
  document.getElementById("btnCloseMasterDetails").onclick = () => masterDetailsCard.classList.add("hidden");

  async function refreshFeed() {
    const list = document.getElementById("feed");
    list.innerHTML = "";
    const orders = await api("/orders/feed");
    if (!orders.length) {
      list.innerHTML = `<div class="muted">Нет открытых заявок</div>`;
      return;
    }
    for (const o of orders) {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div><b>#${o.id}</b> <span class="badge">${o.status}</span></div>
        <div class="muted">${escapeHtml(o.address_text)}</div>
        <div style="margin-top:6px;">${escapeHtml(o.description)}</div>
        <div class="actions">
          <button class="secondary" data-open="${o.id}">Открыть</button>
          <button data-respond="${o.id}">Откликнуться</button>
          <button class="secondary" data-withdraw="${o.id}">Отменить отклик</button>
        </div>
      `;
      el.querySelector("[data-open]").onclick = () => openMasterOrder(o.id);
      el.querySelector("[data-respond]").onclick = () => respond(o.id);
      el.querySelector("[data-withdraw]").onclick = () => withdraw(o.id);
      list.appendChild(el);
    }
  }

  async function respond(orderId) {
    await api(`/orders/${orderId}/respond`, { method:"POST" });
    toast("Отклик отправлен");
  }

  async function withdraw(orderId) {
    await api(`/orders/${orderId}/responses/me/withdraw`, { method:"POST" });
    toast("Отклик отменён");
  }

  async function openMasterOrder(orderId) {
    const details = await api(`/orders/${orderId}`);
    const o = details.order;
    const myResp = (details.responses || [])[0];

    masterDetailsCard.classList.remove("hidden");
    document.getElementById("masterOrderDetails").innerHTML = `
      <div><b>#${o.id}</b> <span class="badge">${o.status}</span></div>
      <div class="muted">${escapeHtml(o.address_text)}</div>
      <div style="margin-top:8px;">${escapeHtml(o.description)}</div>
      <div style="margin-top:10px;"><b>Мой отклик:</b> ${myResp ? `<span class="badge">${myResp.status}</span>` : `<span class="muted">нет</span>`}</div>
      <div class="actions">
        <button onclick="respond(${o.id})">Откликнуться</button>
        <button class="secondary" onclick="withdraw(${o.id})">Отменить отклик</button>
      </div>
    `;
  }

  function escapeHtml(s) {
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  (async function boot() {
    try { await ensureAuth(); showMode(); }
    catch(e){ toast(e.message); showMode(); }
  })();

  window.respond = respond;
  window.withdraw = withdraw;
</script>
</body>
</html>
